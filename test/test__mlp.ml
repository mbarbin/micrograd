open! Core
open! Micrograd

let example =
  (* [ [inputs], desired output ] *)
  [ [ 2.; 3.; -1. ], 1.
  ; [ 3.; -1.; 0.5 ], -1.
  ; [ 0.5; 1.; 1. ], -1.
  ; [ 1.; 1.; -1. ], 1.
  ]
  |> List.map ~f:(fun (inputs, desired_target) ->
    let inputs = inputs |> Array.of_list_map ~f:Value.Expression.leaf in
    inputs, desired_target)
;;

let%expect_test "learning" =
  let mlp = Mlp.create ~num_inputs:3 ~num_outputs:1 ~hidden_layers:[ 4; 4 ] in
  let prediction =
    List.map example ~f:(fun (inputs, _desired_target) -> (Mlp.apply mlp ~inputs).(0))
  in
  let loss =
    let open Value.Expression in
    List.map2_exn example prediction ~f:(fun (_, desired_target) output ->
      (output - leaf desired_target) ** 2)
    |> List.reduce ~f:( + )
    |> Option.value_exn ~here:[%here]
  in
  let print_loss () =
    let prediction = List.map prediction ~f:Value.data in
    let loss = Value.data loss in
    print_s [%sexp { prediction : float list; loss : float }]
  in
  print_loss ();
  [%expect
    {|
      ((prediction
        (-0.45772202427110337 -0.019124740390236327 -0.40017686843444161
         0.1684303683262241))
       (loss 4.1383656164427371)) |}];
  Value.run_backward_propagation loss;
  let print_ws () =
    let ws =
      Array.mapi mlp.layers ~f:(fun i layer ->
        let neurons =
          Array.mapi layer.neurons ~f:(fun i neuron ->
            [%sexp
              { neuron = (i : int)
              ; b = ((Value.data neuron.bias, Value.gradient neuron.bias) : float * float)
              ; ws =
                  (Array.map neuron.weights ~f:(fun w -> Value.data w, Value.gradient w)
                    : (float * float) array)
              }])
        in
        [%sexp { layer = (i : int) }, (neurons : Sexp.t array)])
    in
    print_s [%sexp (ws : Sexp.t array)]
  in
  print_ws ();
  [%expect
    {|
    ((((layer 0))
      (((neuron 0) (b (0 -0.12260747830595031))
        (ws
         ((0.27070282463351214 -1.4120108084825815)
          (0.56510093449375964 1.3490227548202425)
          (0.54417517621722777 -0.79076878957392216))))
       ((neuron 1) (b (0 0.20882712911891665))
        (ws
         ((-0.025689636291400308 1.6107071285341377)
          (0.10803504458667734 -1.9739802734044538)
          (-0.82259676421212446 1.0002573162260613))))
       ((neuron 2) (b (0 -0.88461513217112209))
        (ws
         ((0.36473830945288621 -0.8392390131992904)
          (-0.94439733586942276 -1.6069077876636579)
          (-0.49180448134078891 1.3352070134325671))))
       ((neuron 3) (b (0 -0.55099070067719913))
        (ws
         ((-0.41892762563833519 -1.20425169125646)
          (0.52761480068130484 -1.8980074386588339)
          (0.40699996206643529 1.2835758882122552))))))
     (((layer 1))
      (((neuron 0) (b (0 -0.36233913977741372))
        (ws
         ((0.2850340163541778 -0.38989184965376522)
          (-0.20557775764047836 -2.5016748097240433)
          (0.77493257479855537 1.8431362431409319)
          (0.9903620865549434 -0.892652768589514))))
       ((neuron 1) (b (0 -0.015001195897689217))
        (ws
         ((-0.12796852321265328 -0.010973540473064911)
          (0.4620677759444245 -0.048839913223831549)
          (0.11010826593335254 0.031414227663304317)
          (0.37439673266422346 -0.011741159146580971))))
       ((neuron 2) (b (0 0.39566950975931392))
        (ws
         ((0.948942194415308 0.45918944149707086)
          (-0.99877724153745706 2.0525306687990441)
          (-0.48240378298270548 -2.1650368275648355)
          (0.5837479564158663 1.268820713861744))))
       ((neuron 3) (b (0 0.04306434477926261))
        (ws
         ((0.58718700536427293 0.049587587392458284)
          (0.70603344956869862 -0.18449785694543153)
          (-0.54031389887588 0.077899819995812469)
          (0.17059758782553458 -0.037095589239499127))))))
     (((layer 2))
      (((neuron 0) (b (0 -0.95202290394326461))
        (ws
         ((0.58476160504891883 1.7476955925277737)
          (0.011593830416168904 -2.1227767225277177)
          (-0.670676044257005 0.38190871046001984)
          (0.089793595423356631 -3.798984055982614))))))) |}];
  let parameters = Mlp.parameters mlp in
  let optimization_step () =
    let epsilon = 0.01 in
    Appendable_list.iter parameters ~f:(fun parameter ->
      Value.update_data parameter ~f:(fun data ->
        data -. (epsilon *. Value.gradient parameter)));
    Value.run_forward loss;
    Value.run_backward_propagation loss
  in
  optimization_step ();
  print_loss ();
  [%expect
    {|
    ((prediction
      (-0.34095833121751462 -0.14047151098726271 -0.37450442189742533
       0.26865890069497478))
     (loss 3.4630629912447377)) |}];
  print_ws ();
  [%expect
    {|
    ((((layer 0))
      (((neuron 0) (b (0.001226074783059503 -0.071391599678129511))
        (ws
         ((0.284822932718338 -1.0591406855340018)
          (0.55161070694555725 1.1127122637481512)
          (0.552082864112967 -0.60837589855844532))))
       ((neuron 1) (b (-0.0020882712911891666 0.1228334976998649))
        (ws
         ((-0.041796707576741685 1.2351039620814559)
          (0.12777484732072189 -1.8717268075250024)
          (-0.83259933737438507 0.96263976885869273))))
       ((neuron 2) (b (0.0088461513217112219 -0.78824386265497592))
        (ws
         ((0.3731306995848791 -0.85105644210957165)
          (-0.92832825799278618 -1.5292916777320382)
          (-0.50515655147511462 1.1850837282854885))))
       ((neuron 3) (b (0.0055099070067719915 -0.59077495063813934))
        (ws
         ((-0.40688510872577061 -1.2829956815572841)
          (0.54659487506789317 -1.9819158857457726)
          (0.39416420318431272 1.3348505368488996))))))
     (((layer 1))
      (((neuron 0) (b (0.0036233913977741371 -0.51723945319128417))
        (ws
         ((0.28893293485071547 -0.46274864343496536)
          (-0.18056100954323792 -2.4639058744833315)
          (0.75650121236714607 1.669766779779986)
          (0.99928861424083859 -0.90287899780937309))))
       ((neuron 1) (b (0.00015001195897689217 -0.04002001019867716))
        (ws
         ((-0.12785878780792265 -0.02865369716009069)
          (0.4625561750766628 -0.13258604824762354)
          (0.10979412365671951 0.076308363586288314)
          (0.3745141442556893 -0.03472561518076029))))
       ((neuron 2) (b (-0.003956695097593139 0.50733999506518779))
        (ws
         ((0.94435030000033737 0.50762200596653317)
          (-1.0193025482254474 1.9692177397951052)
          (-0.46075341470705711 -1.9746272838389725)
          (0.5710597492772489 1.2586583099954938))))
       ((neuron 3) (b (-0.00043064344779262609 0.064440894255156617))
        (ws
         ((0.5866911294903483 0.077083176769816214)
          (0.70787842813815294 -0.24769499410511381)
          (-0.54109289707583808 0.077044030970253308)
          (0.17096854371792958 -0.041117743257125541))))))
     (((layer 2))
      (((neuron 0) (b (0.0095202290394326462 -0.96657490773596133))
        (ws
         ((0.56728464912364107 1.24321802441765)
          (0.032821597641446085 -2.1283079496959756)
          (-0.67449513136160522 0.55300486101553536)
          (0.12778343598318276 -3.4968072347128092))))))) |}];
  optimization_step ();
  print_loss ();
  [%expect
    {|
    ((prediction
      (-0.21384656466753213 -0.24074700869484403 -0.34969192694845741
       0.36254824012132003))
     (loss 2.8791339234094333)) |}];
  print_ws ();
  [%expect
    {|
    ((((layer 0))
      (((neuron 0) (b (0.0019399907798407982 -0.021084231817190269))
        (ws
         ((0.29541433957367796 -0.747986773853109)
          (0.54048358430807575 0.91215899144729973)
          (0.55816662309855147 -0.454093772224888))))
       ((neuron 1) (b (-0.0033166062681878154 0.058688507903864984))
        (ws
         ((-0.054147747197556245 0.89206565634188451)
          (0.1464921153959719 -1.7122800954031809)
          (-0.842225735062972 0.90416294581073764))))
       ((neuron 2) (b (0.016728589948260979 -0.68359586291884566))
        (ws
         ((0.38164126400597481 -0.8292669600002458)
          (-0.91303534121546581 -1.427250006280953)
          (-0.51700738875796948 1.0351823282203263))))
       ((neuron 3) (b (0.011417656513153386 -0.51862639075646932))
        (ws
         ((-0.39405515191019774 -1.1631074333578493)
          (0.566414033925351 -1.7946123374608423)
          (0.38081569781582375 1.277394637161553))))))
     (((layer 1))
      (((neuron 0) (b (0.0087957859296869789 -0.52924425748005888))
        (ws
         ((0.2935604212850651 -0.44819246183326766)
          (-0.1559219507984046 -2.324029401069525)
          (0.73980354456934616 1.4364881632221058)
          (1.0083174042189322 -0.89127224133877259))))
       ((neuron 1) (b (0.00055021206096366381 -0.05451699295694467))
        (ws
         ((-0.12757225083632173 -0.038733997913349721)
          (0.46388203555913904 -0.20357575956346313)
          (0.10903104002085662 0.10251452160546515)
          (0.37486140040749688 -0.056815565317061771))))
       ((neuron 2) (b (-0.0090300950482450175 0.58798326090228825))
        (ws
         ((0.939274079940672 0.55073611096625641)
          (-1.0389947256233985 1.8292801082911581)
          (-0.44100714186866741 -1.7566352757591788)
          (0.55847316617729392 1.2212601840817798))))
       ((neuron 3) (b (-0.0010750523903441923 0.0917325564767748))
        (ws
         ((0.58592029772265009 0.10569655505327655)
          (0.71035537807920413 -0.29107733413193315)
          (-0.5418633373855406 0.058398837167778321)
          (0.17137972115050085 -0.037016200472840322))))))
     (((layer 2))
      (((neuron 0) (b (0.019185978116792259 -0.8519367696557536))
        (ws
         ((0.5548524688794646 0.74820753573146792)
          (0.054104677138405846 -2.0796692790466116)
          (-0.6800251799717606 0.68533773350361216)
          (0.16275150833031085 -3.1071746677141467))))))) |}];
  optimization_step ();
  print_loss ();
  [%expect
    {|
    ((prediction
      (-0.090225061118891933 -0.32180189027951228 -0.32862503391161257
       0.44462506106702171))
     (loss 2.4077290278051273)) |}];
  print_ws ();
  [%expect
    {|
    ((((layer 0))
      (((neuron 0) (b (0.0021508330980127008 0.017058959034238971))
        (ws
         ((0.30289420731220906 -0.51548627581478512)
          (0.53136199439360277 0.76322870665966858)
          (0.56270756082080031 -0.337348189128438))))
       ((neuron 1) (b (-0.0039034913472264653 0.032976674580081133))
        (ws
         ((-0.063068403760975084 0.64700554066654681)
          (0.16361491635000372 -1.5265118099161445)
          (-0.85126736452107943 0.84120522485639837))))
       ((neuron 2) (b (0.023564548577449437 -0.5785547996191619))
        (ws
         ((0.38993393360597728 -0.77533040971242551)
          (-0.89876284115265626 -1.3025533018999065)
          (-0.52735921204017278 0.89520522254529755))))
       ((neuron 3) (b (0.01660392042071808 -0.37732156379344506))
        (ws
         ((-0.38242407757661923 -0.92382313002742766)
          (0.58436015729995938 -1.4399138950119315)
          (0.3680417514442082 1.1518482875227811))))))
     (((layer 1))
      (((neuron 0) (b (0.014088228504487568 -0.42502676702776876))
        (ws
         ((0.29804234590339779 -0.35321362877142359)
          (-0.13268165678770935 -2.113573622605819)
          (0.72543866293712511 1.1692390924262648)
          (1.01723012663232 -0.82736658880555969))))
       ((neuron 1) (b (0.0010953819905331105 -0.053745716947773969))
        (ws
         ((-0.12718491085718822 -0.037557022258257661)
          (0.46591779315477366 -0.25712577235804213)
          (0.10800589480480197 0.1096006176469925)
          (0.37542955606066752 -0.07211408224587737))))
       ((neuron 2) (b (-0.0149099276572679 0.61958585953282852))
        (ws
         ((0.93376671883100948 0.568185258943761)
          (-1.05728752670631 1.6703516857509517)
          (-0.42344078911107563 -1.546719752115953)
          (0.54626056433647607 1.1644637320677587))))
       ((neuron 3) (b (-0.00199237795511194 0.12359098390857789))
        (ws
         ((0.58486333217211728 0.13415287578995469)
          (0.71326615142052341 -0.31690987490949191)
          (-0.54244732575721843 0.029542068901491379)
          (0.17174988315522924 -0.025510104014557226))))))
     (((layer 2))
      (((neuron 0) (b (0.027705345813349797 -0.64019108835166927))
        (ws
         ((0.54737039352214989 0.36683922766988963)
          (0.074901369928871961 -1.9795434056536645)
          (-0.6868785573067967 0.81683979107180327)
          (0.19382325500745232 -2.6750795786987513))))))) |}];
  ();
  for _ = 1 to 30 do
    optimization_step ()
  done;
  print_loss ();
  [%expect
    {|
    ((prediction
      (0.75842331763191839 -0.85775305403261193 -0.67099016166539127
       0.85484817209957242))
     (loss 0.20791001396481873)) |}];
  print_ws ();
  [%expect
    {|
    ((((layer 0))
      (((neuron 0) (b (-0.022056041207759454 0.049802799923268519))
        (ws
         ((0.3015440799776411 0.050201011362973919)
          (0.43350328160175827 0.1441608669243013)
          (0.58304956997612012 -0.01522716460301243))))
       ((neuron 1) (b (-0.03489486300370908 0.083622223610811619))
        (ws
         ((-0.10075302724586058 0.030050654921192382)
          (0.28388936194702546 -0.054944331707903762)
          (-0.981282516878857 0.20250478701668073))))
       ((neuron 2) (b (0.077088072148946585 -0.057987178325936278))
        (ws
         ((0.49621867226678285 -0.15366965455401368)
          (-0.73319668853566944 -0.22550543230677528)
          (-0.62978075339902573 0.14026396824984338))))
       ((neuron 3) (b (-0.021643933643281682 0.12890276205906889))
        (ws
         ((-0.36313869383554642 0.038036220876886226)
          (0.60884666144425625 0.095246054863968227)
          (0.21991027370767782 0.23496998733696223))))))
     (((layer 1))
      (((neuron 0) (b (-0.023348385789138556 0.12959966028369313))
        (ws
         ((0.26330772954694109 0.12109609258199898)
          (0.097102410785585958 -0.2640406440061695)
          (0.70235234920369982 -0.0996507195513881)
          (1.057037097975585 0.022297169645362665))))
       ((neuron 1) (b (-0.014597273502256472 0.047557569398900532))
        (ws
         ((-0.14265795278059282 0.048227605934566681)
          (0.5408116305976467 -0.14086789820620615)
          (0.11601137177058574 -0.053074133143382066)
          (0.37781703491288204 0.010098626125272132))))
       ((neuron 2) (b (-0.1230499361279785 0.14008296866268155))
        (ws
         ((0.838401535641677 0.11394346745580729)
          (-1.26478834036576 0.25019294925076085)
          (-0.2790716745067981 -0.090635263390664689)
          (0.40151784102144855 0.15166938925334555))))
       ((neuron 3) (b (-0.05316023757227932 0.097208407467568356))
        (ws
         ((0.53625711949365751 0.093853585494216893)
          (0.78291473783491117 -0.12709296675078377)
          (-0.50993501244092732 -0.089206736531710976)
          (0.15278648854542021 0.04700721283018023))))))
     (((layer 2))
      (((neuron 0) (b (-0.023558797120814261 0.15354072300111438))
        (ws
         ((0.572776350519393 -0.11111584836531105)
          (0.32518883597915649 -0.31473254037632786)
          (-0.95178112229776424 0.48903961727039957)
          (0.39143307389254695 -0.15005084913187675))))))) |}];
  for _ = 1 to 30 do
    optimization_step ()
  done;
  print_loss ();
  [%expect
    {|
    ((prediction
      (0.85830961848364606 -0.9111938014330353 -0.80364538819663367
       0.89502014200246294))
     (loss 0.077538609279798831)) |}];
  ()
;;
